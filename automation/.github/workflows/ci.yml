# CrestaStream Test Automation CI/CD Pipeline
# Bu pipeline her push ve pull request'te testleri Ã§alÄ±ÅŸtÄ±rÄ±r

name: CrestaStream CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # Her gÃ¼n 08:00 UTC'de Ã§alÄ±ÅŸ (regression tests)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - e2e
          - api
          - visual

env:
  NODE_VERSION: '20.x'
  BASE_URL: ${{ vars.BASE_URL || 'https://staging.crestastream.example.com' }}
  API_URL: ${{ vars.API_URL || 'https://api.staging.crestastream.example.com' }}

jobs:
  # ============================================
  # Lint ve Type Check
  # ============================================
  lint:
    name: ðŸ” Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸ“ TypeScript type check
        run: npx tsc --noEmit

  # ============================================
  # E2E Tests
  # ============================================
  e2e-tests:
    name: ðŸ§ª E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: lint
    if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == ''
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1, 2]
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ§ª Run E2E tests
        run: |
          npx playwright test tests/e2e/ \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }}/2 \
            --reporter=github,html,json
        env:
          BASE_URL: ${{ env.BASE_URL }}
          API_URL: ${{ env.API_URL }}
          CI: true

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-shard${{ matrix.shard }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: ðŸ“¸ Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-screenshots-${{ matrix.browser }}-shard${{ matrix.shard }}
          path: test-results/**/*.png
          retention-days: 7

      - name: ðŸŽ¬ Upload videos on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-videos-${{ matrix.browser }}-shard${{ matrix.shard }}
          path: test-results/**/*.webm
          retention-days: 7

  # ============================================
  # API Tests
  # ============================================
  api-tests:
    name: ðŸ”Œ API Tests
    runs-on: ubuntu-latest
    needs: lint
    if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'api' || github.event.inputs.test_suite == ''
    timeout-minutes: 15
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ”Œ Run API tests
        run: |
          npx playwright test tests/api/ \
            --project=chromium \
            --reporter=github,html,json
        env:
          API_URL: ${{ env.API_URL }}
          CI: true

      - name: ðŸ“Š Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ============================================
  # Visual Regression Tests
  # ============================================
  visual-tests:
    name: ðŸ‘ï¸ Visual Regression Tests
    runs-on: ubuntu-latest
    needs: lint
    if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'visual' || github.event.inputs.test_suite == ''
    timeout-minutes: 20
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸŽ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ðŸ‘ï¸ Run visual regression tests
        run: |
          npx playwright test tests/visual/ \
            --project=chromium \
            --reporter=github,html
        env:
          BASE_URL: ${{ env.BASE_URL }}
          CI: true

      - name: ðŸ“¸ Upload visual snapshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-snapshots
          path: |
            tests/visual/*.png
            test-results/**/*-diff.png
            test-results/**/*-actual.png
          retention-days: 30

      - name: ðŸ“Š Upload visual report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-report
          path: playwright-report/
          retention-days: 30

  # ============================================
  # Merge Reports
  # ============================================
  merge-reports:
    name: ðŸ“‹ Merge & Publish Reports
    runs-on: ubuntu-latest
    needs: [e2e-tests, api-tests, visual-tests]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“š Install dependencies
        run: npm ci

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: ðŸ“‹ Merge reports
        run: |
          mkdir -p merged-report
          # JSON raporlarÄ± birleÅŸtir
          find downloaded-artifacts -name "*.json" -exec cat {} \; > merged-report/all-results.json || true
          echo "Reports merged successfully"

      - name: ðŸ“Š Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: merged-test-report
          path: merged-report/
          retention-days: 30

      - name: ðŸ“¢ Summary
        run: |
          echo "## ðŸŽ­ CrestaStream Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.api-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual Tests | ${{ needs.visual-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Download artifacts from the Actions tab for detailed reports." >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Slack Notification (Optional)
  # ============================================
  notify:
    name: ðŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [e2e-tests, api-tests, visual-tests]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¢ Send Slack notification
        uses: 8398a7/action-slack@v3
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          mention: 'here'
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
